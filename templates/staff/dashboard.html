{% extends "base.html" %}

{% block title %}Công việc của tôi - TicketSys{% endblock %}

{% block content %}
<div class="mb-6 flex items-center justify-between">
    <div>
        <h2 class="text-2xl font-bold dark:text-white tracking-tight">Công việc của tôi</h2>
        <p class="text-slate-500 dark:text-slate-400 text-sm">Thống kê và danh sách yêu cầu cần xử lý.</p>
    </div>
</div>

<!-- Stats and Charts -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <!-- Key Metrics -->
    <div class="space-y-6">
        <div
            class="bg-white dark:bg-[#111418] p-6 rounded-xl border border-slate-200 dark:border-[#3b4754] shadow-sm flex items-center justify-between">
            <div>
                <p class="text-xs text-slate-500 uppercase tracking-widest font-bold mb-1">Chờ xử lý</p>
                <h3 class="text-3xl font-bold text-slate-900 dark:text-white">{{ my_pending }}</h3>
            </div>
            <div
                class="w-12 h-12 rounded-full bg-amber-50 dark:bg-amber-900/20 flex items-center justify-center text-amber-600 dark:text-amber-400">
                <span class="material-symbols-outlined">pending_actions</span>
            </div>
        </div>

        <div
            class="bg-white dark:bg-[#111418] p-6 rounded-xl border border-slate-200 dark:border-[#3b4754] shadow-sm flex items-center justify-between">
            <div>
                <p class="text-xs text-slate-500 uppercase tracking-widest font-bold mb-1">Đã hoàn thành</p>
                <h3 class="text-3xl font-bold text-slate-900 dark:text-white">{{ my_resolved }}</h3>
            </div>
            <div
                class="w-12 h-12 rounded-full bg-emerald-50 dark:bg-emerald-900/20 flex items-center justify-center text-emerald-600 dark:text-emerald-400">
                <span class="material-symbols-outlined">check_circle</span>
            </div>
        </div>
    </div>

    <!-- Status Chart -->
    <div class="bg-white dark:bg-[#111418] p-6 rounded-xl border border-slate-200 dark:border-[#3b4754] shadow-sm">
        <h3 class="text-sm font-bold dark:text-white mb-4">Trạng thái công việc</h3>
        <div class="w-full h-48 relative">
            <canvas id="statusChart"></canvas>
        </div>
    </div>
</div>

<!-- Pending Tickets List -->
<div
    class="bg-white dark:bg-[#111418] border border-slate-200 dark:border-[#3b4754] rounded-xl overflow-hidden flex flex-col shadow-sm">
    <div class="p-4 border-b border-slate-200 dark:border-slate-800 bg-slate-50/50 dark:bg-white/5">
        <h3 class="font-bold dark:text-white flex items-center gap-2">
            <span class="material-symbols-outlined text-primary">list</span>
            Danh sách Yêu cầu cần xử lý
        </h3>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full text-left">
            <thead>
                <tr
                    class="bg-slate-50 dark:bg-slate-800/80 text-slate-500 dark:text-[#9dabb9] text-xs font-bold uppercase tracking-wider">
                    <th class="px-6 py-4">Trạng thái</th>
                    <th class="px-6 py-4">Yêu cầu</th>
                    <th class="px-6 py-4">Độ ưu tiên</th>
                    <th class="px-6 py-4 text-right">Thao tác</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
                {% for ticket in tickets %}
                <tr class="hover:bg-slate-50 dark:hover:bg-white/5 transition-colors group">
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold uppercase tracking-wider 
                         {% if ticket.status == 'New' %} bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-500
                         {% elif ticket.status == 'Assigned' %} bg-indigo-100 text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-500
                         {% elif ticket.status == 'In Progress' %} bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-500
                         {% elif ticket.status == 'Waiting' %} bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-500
                         {% else %} bg-slate-100 text-slate-800 dark:bg-slate-800 dark:text-slate-400 {% endif %}">
                            {{ ticket.status }}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-medium text-slate-900 dark:text-white">{{ ticket.title }}</div>
                        <div class="text-xs text-slate-400 font-mono mt-0.5">#{{ ticket.id }}</div>
                    </td>
                    <td class="px-6 py-4">
                        {% if ticket.priority == 'Critical' %}
                        <span class="text-red-600 font-bold dark:text-red-500">Khẩn cấp</span>
                        {% elif ticket.priority == 'High' %}
                        <span class="text-orange-600 font-medium dark:text-orange-500">Cao</span>
                        {% else %}
                        <span class="text-slate-500 font-medium dark:text-slate-400">{{ ticket.priority }}</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-right">
                        <a href="{{ url_for('user.view_ticket', ticket_id=ticket.id) }}"
                            class="text-primary hover:underline text-xs font-bold">Xử lý</a>
                    </td>
                </tr>
                {% endfor %}
                {% if not tickets %}
                <tr>
                    <td colspan="4" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">
                        Không có yêu cầu nào cần xử lý.
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
    const statusData = {{ status_counts | tojson }};

    Chart.defaults.color = '#64748b';
    Chart.defaults.font.family = 'Inter';

    new Chart(document.getElementById('statusChart'), {
        type: 'pie',
        data: {
            labels: Object.keys(statusData),
            datasets: [{
                data: Object.values(statusData),
                backgroundColor: ['#3b82f6', '#6366f1', '#f59e0b', '#a855f7', '#10b981', '#64748b'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right', labels: { usePointStyle: true } }
            }
        }
    });
</script>
{% endblock %}