{% extends "base.html" %}

{% block title %}Tổng quan Quản lý - TicketSys{% endblock %}

{% block content %}
<div class="flex flex-col md:flex-row justify-between items-end md:items-center gap-4 mb-4">
    <div>
        <h2 class="text-2xl font-bold dark:text-white tracking-tight">Tổng quan Hoạt động</h2>
        <p class="text-slate-500 dark:text-slate-400 text-sm">Theo dõi hiệu suất đội ngũ và tình trạng hệ thống thông
            qua biểu đồ.</p>
    </div>

    <!-- Time Range Filter -->
    <div class="bg-white dark:bg-[#111418] border border-slate-200 dark:border-[#3b4754] rounded-lg p-1">
        <select id="timeRangeFilter" onchange="updateDashboard(this.value)"
            class="text-xs font-bold bg-transparent border-0 focus:ring-0 text-slate-700 dark:text-slate-300 py-1.5 pl-2 pr-8 cursor-pointer hover:bg-slate-50 dark:hover:bg-white/5 rounded-md transition-colors">
            <option value="this_month" {% if current_range=='this_month' %}selected{% endif %}>Tháng này</option>
            <option value="last_month" {% if current_range=='last_month' %}selected{% endif %}>Tháng trước</option>
            <option value="7d" {% if current_range=='7d' %}selected{% endif %}>7 Ngày qua</option>
            <option value="30d" {% if current_range=='30d' %}selected{% endif %}>30 Ngày qua</option>
            <option value="all" {% if current_range=='all' %}selected{% endif %}>Tất cả thời gian</option>
        </select>
    </div>
</div>

<!-- SLA Alerts -->
{% if sla_warnings %}
<div
    class="mb-8 p-4 bg-red-50 dark:bg-red-900/10 border border-red-200 dark:border-red-800 rounded-xl flex items-start gap-3">
    <span class="material-symbols-outlined text-red-600 dark:text-red-400">warning</span>
    <div class="flex-1">
        <h3 class="text-sm font-bold text-red-800 dark:text-red-400">Cảnh báo vi phạm SLA</h3>
        <p class="text-xs text-red-600 dark:text-red-300 mt-1">Có {{ sla_warnings|length }} yêu cầu chưa được xử lý đúng
            hạn (Mới > 24h hoặc Đang xử lý > 48h).</p>
        <div class="mt-3 flex flex-wrap gap-2">
            {% for ticket in sla_warnings[:5] %}
            <a href="{{ url_for('user.view_ticket', ticket_id=ticket.id) }}"
                class="inline-flex items-center gap-1 bg-white dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded px-2 py-1 text-xs font-medium text-red-700 dark:text-red-300 hover:bg-red-50 transition-colors">
                #{{ ticket.id }}
                <span class="text-[10px] opacity-75">({{ ticket.status_label }})</span>
            </a>
            {% endfor %}
            {% if sla_warnings|length > 5 %}
            <span class="text-xs text-red-600 self-center pl-1">+{{ sla_warnings|length - 5 }} yêu cầu khác</span>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- Key Metrics Distribution -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <!-- Card 1: Waiting Assignment -->
    <div
        class="bg-white dark:bg-[#111418] p-6 rounded-xl border border-slate-200 dark:border-[#3b4754] shadow-sm flex flex-col justify-between">
        <div>
            <p class="text-xs text-slate-500 uppercase tracking-widest font-bold mb-1">Chờ phân công</p>
            <h3 class="text-3xl font-bold text-slate-900 dark:text-white">{{ waiting_assignment_count }}</h3>
        </div>
        <div class="mt-4 flex justify-between items-center">
            <a href="{{ url_for('leader.assignment') }}" class="text-xs font-bold text-primary hover:underline">Phân
                công ngay</a>
            <span class="material-symbols-outlined text-slate-300">person_add</span>
        </div>
    </div>

    <!-- Card 2: Assigned & Active -->
    <div
        class="bg-white dark:bg-[#111418] p-6 rounded-xl border border-slate-200 dark:border-[#3b4754] shadow-sm flex flex-col justify-between">
        <div>
            <p class="text-xs text-slate-500 uppercase tracking-widest font-bold mb-1">Đang thực hiện</p>
            <h3 class="text-3xl font-bold text-slate-900 dark:text-white">{{ assigned_count }}</h3>
        </div>
        <div class="mt-4 flex justify-between items-center">
            <span class="text-xs text-emerald-600 font-bold flex items-center gap-1">
                <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                Active
            </span>
            <span class="material-symbols-outlined text-emerald-200 dark:text-emerald-900/40">engineering</span>
        </div>
    </div>

    <!-- Card 3: Resolved (Filtered) -->
    <div
        class="bg-white dark:bg-[#111418] p-6 rounded-xl border border-slate-200 dark:border-[#3b4754] shadow-sm flex flex-col justify-between">
        <div>
            <p class="text-xs text-slate-500 uppercase tracking-widest font-bold mb-1">Hoàn thành (Kỳ này)</p>
            <div class="flex items-baseline gap-2">
                <h3 id="stat-resolved" class="text-3xl font-bold text-slate-900 dark:text-white">{{ resolved_tickets }}
                </h3>
                {% if delta_resolved is defined and delta_resolved != 0 %}
                <span id="delta-resolved"
                    class="text-xs font-bold {% if delta_resolved > 0 %}text-emerald-600{% else %}text-red-500{% endif %}">
                    {% if delta_resolved > 0 %}▲{% else %}▼{% endif %} {{ delta_resolved | abs }}
                </span>
                {% endif %}
            </div>
        </div>
        <div class="mt-4 flex justify-end">
            <span class="material-symbols-outlined text-indigo-200 dark:text-indigo-900/40">task_alt</span>
        </div>
    </div>

    <!-- Card 4: Total Volume -->
    <div
        class="bg-white dark:bg-[#111418] p-6 rounded-xl border border-slate-200 dark:border-[#3b4754] shadow-sm flex flex-col justify-between">
        <div>
            <p class="text-xs text-slate-500 uppercase tracking-widest font-bold mb-1">Tổng tiếp nhận</p>
            <div class="flex items-baseline gap-2">
                <h3 id="stat-total" class="text-3xl font-bold text-slate-900 dark:text-white">{{ total_tickets }}</h3>
                {% if delta_total is defined and delta_total != 0 %}
                <span id="delta-total"
                    class="text-xs font-bold {% if delta_total > 0 %}text-emerald-600{% else %}text-red-500{% endif %}">
                    {% if delta_total > 0 %}▲{% else %}▼{% endif %} {{ delta_total | abs }}
                </span>
                {% endif %}
            </div>
        </div>
        <div class="mt-4 flex justify-end">
            <span class="material-symbols-outlined text-blue-200 dark:text-blue-900/40">inbox</span>
        </div>
    </div>
</div>

<!-- Charts Split -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Workload Distribution Chart (Stacked) -->
    <div class="bg-white dark:bg-[#111418] p-6 rounded-xl border border-slate-200 dark:border-[#3b4754] shadow-sm">
        <h3 class="text-lg font-bold dark:text-white mb-6">Hiệu suất Nhân viên (Load vs Resolved)</h3>
        <div class="w-full h-80 relative">
            <canvas id="staffChart"></canvas>
        </div>
    </div>

    <!-- Ticket Category Chart -->
    <div class="bg-white dark:bg-[#111418] p-6 rounded-xl border border-slate-200 dark:border-[#3b4754] shadow-sm">
        <h3 class="text-lg font-bold dark:text-white mb-6">Phân loại Yêu cầu</h3>
        <div class="w-full h-80 relative">
            <canvas id="categoryChart"></canvas>
        </div>
    </div>
</div>

<script id="status-data" type="text/plain">
    {{ status_counts | tojson }}
</script>
<script id="category-data" type="text/plain">
    {{ category_counts | tojson }}
</script>
<script id="staff-labels" type="text/plain">
    {{ staff_labels | tojson }}
</script>
<script id="staff-active" type="text/plain">
    {{ staff_active | tojson }}
</script>
<script id="staff-resolved" type="text/plain">
    {{ staff_resolved | tojson }}
</script>

<script>
    // --- Data from Flask ---
    let statusData = JSON.parse(document.getElementById('status-data').textContent);
    let categoryData = JSON.parse(document.getElementById('category-data').textContent);

    let staffLabels = JSON.parse(document.getElementById('staff-labels').textContent);
    let staffActive = JSON.parse(document.getElementById('staff-active').textContent);
    let staffResolved = JSON.parse(document.getElementById('staff-resolved').textContent);

    // --- Chart Configs ---
    Chart.defaults.color = '#64748b';
    Chart.defaults.font.family = 'Inter';

    let categoryChart, staffChart;

    function initCharts() {
        // 1. Category Chart
        if (categoryChart) categoryChart.destroy();
        categoryChart = new Chart(document.getElementById('categoryChart'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(categoryData),
                datasets: [{
                    data: Object.values(categoryData),
                    backgroundColor: ['#ec4899', '#f43f5e', '#8b5cf6', '#06b6d4', '#14b8a6'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { usePointStyle: true } }
                }
            }
        });

        // 2. Workload Distribution Chart (Stacked Bar)
        if (staffChart) staffChart.destroy();
        staffChart = new Chart(document.getElementById('staffChart'), {
            type: 'bar',
            data: {
                labels: staffLabels,
                datasets: [
                    {
                        label: 'Hoàn thành (Tháng)',
                        data: staffResolved,
                        backgroundColor: '#10b981', // Green for Resolved
                        borderRadius: 4,
                    },
                    {
                        label: 'Đang xử lý',
                        data: staffActive,
                        backgroundColor: '#f59e0b', // Yellow/Amber for In Progress
                        borderRadius: 4,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: '#e2e8f0' },
                        stacked: true
                    },
                    x: {
                        grid: { display: false },
                        stacked: true
                    }
                },
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });
    }

    initCharts();

    async function updateDashboard(range) {
        try {
            const response = await fetch(`/leader/dashboard?time_range=${range}`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            if (!response.ok) throw new Error('Network response was not ok');

            const data = await response.json();

            // Update Stats
            document.getElementById('stat-total').textContent = data.total_tickets;
            // Update Delta Total logic...
            // (Assuming delta elements exist and logic matches previous snippet)
            const deltaTotalEl = document.getElementById('delta-total');
            if (deltaTotalEl) {
                if (data.delta_total !== undefined && data.delta_total !== 0) {
                    deltaTotalEl.classList.remove('hidden', 'text-emerald-600', 'text-red-500');
                    deltaTotalEl.classList.add(data.delta_total > 0 ? 'text-emerald-600' : 'text-red-500');
                    deltaTotalEl.textContent = (data.delta_total > 0 ? '▲ ' : '▼ ') + Math.abs(data.delta_total);
                } else {
                    deltaTotalEl.classList.add('hidden');
                }
            }

            document.getElementById('stat-resolved').textContent = data.resolved_tickets;
            // Update Delta Resolved
            const deltaResolvedEl = document.getElementById('delta-resolved');
            if (deltaResolvedEl) {
                if (data.delta_resolved !== undefined && data.delta_resolved !== 0) {
                    deltaResolvedEl.classList.remove('hidden', 'text-emerald-600', 'text-red-500');
                    deltaResolvedEl.classList.add(data.delta_resolved > 0 ? 'text-emerald-600' : 'text-red-500');
                    deltaResolvedEl.textContent = (data.delta_resolved > 0 ? '▲ ' : '▼ ') + Math.abs(data.delta_resolved);
                } else {
                    deltaResolvedEl.classList.add('hidden');
                }
            }

            // Note: waiting_assignment and assigned_count in this design are NOT updated by time range filter because they are snapshots of "Now".
            // Only metrics inside the "Current Range" logic (Total Created, Resolved in Period) change.

            // Reload Charts
            categoryData = data.category_counts;
            staffLabels = data.staff_labels;
            staffActive = data.staff_active;
            staffResolved = data.staff_resolved;

            initCharts();

        } catch (error) {
            console.error('Error updating dashboard:', error);
        }
    }
</script>
{% endblock %}