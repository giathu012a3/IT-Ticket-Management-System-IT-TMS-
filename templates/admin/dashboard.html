{% extends "base.html" %}

{% block title %}Thống kê Hệ thống - TicketSys{% endblock %}

{% block content %}
<div class="flex flex-col md:flex-row justify-between items-end md:items-center gap-4">
    <div>
        <h1 class="text-2xl font-bold dark:text-white tracking-tight">Thống kê Hệ thống</h1>
        <p class="text-slate-500 dark:text-slate-400 text-sm">Tổng quan số liệu và hiệu suất hoạt động.</p>
    </div>

    <!-- Time Range Filter -->
    <div class="flex bg-white dark:bg-[#111418] border border-slate-200 dark:border-[#3b4754] rounded-lg p-1">
        <a href="{{ url_for('admin.admin_dashboard', time_range='7d') }}"
            class="px-3 py-1.5 text-xs font-bold rounded-md transition-all {{ 'bg-slate-100 text-slate-900 dark:bg-white/10 dark:text-white' if current_range == '7d' else 'text-slate-500 hover:text-slate-900 dark:hover:text-white' }}">
            7 Ngày
        </a>
        <a href="{{ url_for('admin.admin_dashboard', time_range='30d') }}"
            class="px-3 py-1.5 text-xs font-bold rounded-md transition-all {{ 'bg-slate-100 text-slate-900 dark:bg-white/10 dark:text-white' if current_range == '30d' else 'text-slate-500 hover:text-slate-900 dark:hover:text-white' }}">
            30 Ngày
        </a>
        <a href="{{ url_for('admin.admin_dashboard', time_range='3m') }}"
            class="px-3 py-1.5 text-xs font-bold rounded-md transition-all {{ 'bg-slate-100 text-slate-900 dark:bg-white/10 dark:text-white' if current_range == '3m' else 'text-slate-500 hover:text-slate-900 dark:hover:text-white' }}">
            1 Quý
        </a>
        <a href="{{ url_for('admin.admin_dashboard', time_range='1y') }}"
            class="px-3 py-1.5 text-xs font-bold rounded-md transition-all {{ 'bg-slate-100 text-slate-900 dark:bg-white/10 dark:text-white' if current_range == '1y' else 'text-slate-500 hover:text-slate-900 dark:hover:text-white' }}">
            1 Năm
        </a>
        <a href="{{ url_for('admin.admin_dashboard', time_range='all') }}"
            class="px-3 py-1.5 text-xs font-bold rounded-md transition-all {{ 'bg-slate-100 text-slate-900 dark:bg-white/10 dark:text-white' if current_range == 'all' or not current_range else 'text-slate-500 hover:text-slate-900 dark:hover:text-white' }}">
            Tất cả
        </a>
    </div>
</div>

<!-- Stats Row -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white dark:bg-[#111418] p-6 rounded-xl border border-slate-200 dark:border-[#3b4754] shadow-sm">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Tổng Yêu cầu</h3>
            <span class="material-symbols-outlined text-blue-500">confirmation_number</span>
        </div>
        <p class="text-3xl font-bold text-slate-900 dark:text-white">{{ total_tickets }}</p>
        <p class="text-xs text-slate-400 mt-1">Toàn bộ thời gian</p>
    </div>

    <div class="bg-white dark:bg-[#111418] p-6 rounded-xl border border-slate-200 dark:border-[#3b4754] shadow-sm">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Đánh giá TB</h3>
            <span class="material-symbols-outlined text-amber-500">star</span>
        </div>
        <p class="text-3xl font-bold text-slate-900 dark:text-white">{{ avg_rating }}</p>
        <div class="flex text-amber-400 mt-1 text-xs">
            Trên 5 sao
        </div>
    </div>

    <div class="bg-white dark:bg-[#111418] p-6 rounded-xl border border-slate-200 dark:border-[#3b4754] shadow-sm">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Tổng Người dùng</h3>
            <span class="material-symbols-outlined text-primary">group</span>
        </div>
        <p class="text-3xl font-bold text-slate-900 dark:text-white">{{ total_users }}</p>
        <div class="text-xs text-slate-400 mt-1">Tài khoản trong hệ thống</div>
    </div>

    <div class="bg-white dark:bg-[#111418] p-6 rounded-xl border border-slate-200 dark:border-[#3b4754] shadow-sm">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Sự cố chưa xong</h3>
            <span class="material-symbols-outlined text-red-500">warning</span>
        </div>
        {% set pending_count = total_tickets - status_counts.get('Resolved', 0) - status_counts.get('Closed', 0) %}
        <p class="text-3xl font-bold text-slate-900 dark:text-white">{{ pending_count }}</p>
        <p class="text-xs text-slate-400 mt-1">Cần xử lý</p>
    </div>
</div>

<!-- Charts Row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Ticket Status Chart -->
    <div class="bg-white dark:bg-[#111418] p-6 rounded-xl border border-slate-200 dark:border-[#3b4754] shadow-sm">
        <h3 class="text-sm font-bold dark:text-white mb-6">Trạng thái Yêu cầu</h3>
        <div class="w-full h-64 relative">
            <canvas id="statusChart"></canvas>
        </div>
    </div>

    <!-- Ticket Priority Chart -->
    <div class="bg-white dark:bg-[#111418] p-6 rounded-xl border border-slate-200 dark:border-[#3b4754] shadow-sm">
        <h3 class="text-sm font-bold dark:text-white mb-6">Mức độ Ưu tiên</h3>
        <div class="w-full h-64 relative">
            <canvas id="priorityChart"></canvas>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- User Roles Chart -->
    <div class="bg-white dark:bg-[#111418] p-6 rounded-xl border border-slate-200 dark:border-[#3b4754] shadow-sm">
        <h3 class="text-sm font-bold dark:text-white mb-6">Phân bổ Vai trò</h3>
        <div class="w-full h-64 relative">
            <canvas id="roleChart"></canvas>
        </div>
    </div>
</div>

<script id="status-data" type="application/json">{{ status_counts | tojson }}</script>
<script id="priority-data" type="application/json">{{ priority_counts | tojson }}</script>
<script id="role-data" type="application/json">{{ role_counts | tojson }}</script>

<script>
    // --- Data from Flask ---
    const statusData = JSON.parse(document.getElementById('status-data').textContent);
    const priorityData = JSON.parse(document.getElementById('priority-data').textContent);
    const roleData = JSON.parse(document.getElementById('role-data').textContent);

    // --- Chart Configs ---
    Chart.defaults.color = '#64748b';
    Chart.defaults.font.family = 'Inter';

    // 1. Status Chart
    new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(statusData),
            datasets: [{
                data: Object.values(statusData),
                backgroundColor: ['#3b82f6', '#6366f1', '#f59e0b', '#a855f7', '#10b981', '#64748b'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right', labels: { usePointStyle: true } }
            }
        }
    });

    // 2. Priority Chart
    const priorityOrder = ['Critical', 'High', 'Medium', 'Low'];
    const sortedPriorityLabels = Object.keys(priorityData).sort((a, b) => priorityOrder.indexOf(a) - priorityOrder.indexOf(b));
    const sortedPriorityData = sortedPriorityLabels.map(l => priorityData[l]);

    new Chart(document.getElementById('priorityChart'), {
        type: 'bar',
        data: {
            labels: sortedPriorityLabels,
            datasets: [{
                label: 'Số lượng',
                data: sortedPriorityData,
                backgroundColor: ['#dc2626', '#ea580c', '#3b82f6', '#94a3b8'],
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { color: '#e2e8f0' } },
                x: { grid: { display: false } }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });

    // 3. Role Chart
    new Chart(document.getElementById('roleChart'), {
        type: 'pie',
        data: {
            labels: Object.keys(roleData),
            datasets: [{
                data: Object.values(roleData),
                backgroundColor: ['#10b981', '#3b82f6', '#a855f7', '#64748b'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { usePointStyle: true } }
            }
        }
    });
</script>
{% endblock %}